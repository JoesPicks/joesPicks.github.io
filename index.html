<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.5, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Pick 6">
  <meta name="application-name" content="Pick 6">
  <meta name="theme-color" content="#333">
  <meta name="description" content="Pick 6">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="icon" type="image/png" sizes="32x32" href="Pick6Logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="Pick6Logo.png">

  <link rel="apple-touch-icon" href="Pick6Logo.png">
  <link rel="apple-touch-icon" sizes="152x152" href="Pick6Logo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="Pick6Logo.png">
  <link rel="apple-touch-icon" sizes="167x167" href="Pick6Logo.png">

  <link rel="shortcut icon" href="Pick6Logo.png">

  <link rel="manifest" href="manifest.json">

  <title>Pick 6</title>
  <style>
    html,
    body {
      background-color: #000 !important;
      margin: 0;
      padding: 0;
      overflow: hidden;
      left: 0;
      right: 0;
      width: 100%;
      height: 100%;
      font-family: Arial, sans-serif;
      overscroll-behavior: none;
    }

    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-text-size-adjust: none;
      text-size-adjust: none;
    }

    input,
    textarea {
      font-size: 16px !important;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
      overflow: auto;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #121315;
      overscroll-behavior: none;
    }

    #install-banner {
      display: none;
      text-align: center;
      width: 95%;
      margin: 5px;
      position: fixed;
      bottom: 20px;
      left: 50%;
      right: 0;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 4px 1px 4px 4px;
      border: 4px solid rgb(71, 143, 223);
      border-radius: 10px;
      box-shadow: inset -3px -3px 4px 1px rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.9) 0px 10px 13px;
      z-index: 1001;
      width: 95%;
      min-width: 95%;
      max-width: 95%;
    }

    #install-banner button {
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      background-color: rgba(0, 0, 0, .9);
      color: #478fdf;
      padding: 3px 0;
      font-weight: 900;
      cursor: pointer;
      width: 83px;
      border: 3px solid;
      border-radius: 9px;
      box-shadow: inset -3px -3px 4px 1px rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.9) 0px 3px 4px;
    }

    #install-banner button:hover {
      background-color: #478fdf;
      color: white;
      border: none;
    }

    #ios-install-banner {
      display: none;
      margin: 5px;
      position: fixed;
      bottom: 20px;
      left: 50%;
      right: 0;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 4px 1px 4px 4px;
      border: 4px solid rgb(71, 143, 223);
      border-radius: 10px;
      box-shadow: inset -3px -3px 4px 1px rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.9) 0px 10px 13px;
      z-index: 1001;
      text-align: left;
      width: 95%;
      min-width: 95%;
      max-width: 95%;
    }

    h3 {
      margin: 0 0 10px 0;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
    }

    #ios-install-banner button {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255, 255, 255, .1);
      border: 2px solid #478fdf;
      width: 28px;
      height: 28px;
      font-size: 20px;
      color: #478fdf;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      line-height: 1;
      border-radius: 5px;
      text-align: center;
      text-decoration: none;
      font-weight: bold;
      box-shadow: inset -3px -3px 4px 1px rgba(0, 0, 0, 0.3), 3px 3px 7px -2px rgba(0, 0, 0, 0.9);
    }

    .install-icon-header {
      padding: 0;
      width: 34px;
      height: 34px;
      margin-right: 8px;
      vertical-align: middle;
      border: 2px solid #478fdf;
      border-radius: 8px;
      box-shadow: inset -3px -3px 4px 1px rgba(0, 0, 0, 0.3), 3px 3px 7px -2px rgba(0, 0, 0, 0.9);
    }

    .install-details-header {
      margin: 0 0 7px 0;
      font-size: 16px;
      display: flex;
      align-items: center;
      display: block;
    }

    .install-details {
      font-size: 15px;
      align-items: center;
      justify-content: flex-start;
      padding: 0 0 0 13px;
      align-content: center;
      line-height: 23px;
      margin: 0px;
      display: block;
    }

    strong {
      font-size: 17px;
    }

    .install-icon {
      width: 22px;
      height: 22px;
      object-fit: contain;
      vertical-align: text-bottom;
      padding: 0 4px;
    }

    .notification {
      margin: 0 0 15px 0;
      font-size: 18px;
      width: 350px;
    }

    .notification-button {
      background-color: rgba(0, 0, 0, .9);
      color: #478fdf;
      padding: 6px 0;
      font-weight: 900;
      cursor: pointer;
      flex: 1;
      width: 83px;
      margin: 0 auto;
      border: 4px solid;
      border-radius: 9px;
      box-shadow: inset -3px -3px 4px 1px rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.9) 0px 3px 4px;
    }

    .notification-button:hover {
      background-color: #478fdf;
      color: white;
      border: none;
    }

    #preloader {
      display: none;
    }


    @media (max-width: 1100px) {
      .notification {
        width: -webkit-fill-available;
      }

      #preloader {
        background: linear-gradient(to top, #000 3%, rgba(0, 0, 0, 0.8) 5%, rgba(0, 0, 0, 0) 7%, rgba(18, 19, 21) 50%, rgba(0, 0, 0, 0.8) 90%, #000 101%),
          url(https://www.shutterstock.com/image-illustration/3d-render-soccer-empty-stadium-600nw-2472453011.jpg);
        background-attachment: fixed;
        background-repeat: round;
        background-size: cover;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #333;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 9999;
        overflow: hidden;
        color: white;
        padding: 0px;
        transition: all 1s ease-in-out;
      }

      #preloader-text {
        padding-bottom: 10%;
        border: none;
        height: 153px;
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        font-size: 8rem;
/*         animation: reveal 3000ms ease-in-out forwards, glow 3000ms ease-in-out forwards; */
        font-weight: 900;
        white-space: nowrap;
        line-height: 1;
        text-align: center;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        flex-direction: column;
        align-items: center;
        line-height: .75;
        -webkit-text-stroke: 7px #478fdf;
        transition: all 1s ease-in-out;
      }
      span{
        opacity: 0;
        transition: opacity 1400ms;
      }
      #preloader-text span: nth-child(1){
        transition-delay: 6000ms;
      }
      #preloader-text span: nth-child(2){
        transition-delay: 7000ms;
      }
      #preloader-text span: nth-child(3){
        transition-delay: 7000ms;
      }
      #preloader-text span: nth-child(4){
        transition-delay: 7000ms;
      }
      #preloader-text span: nth-child(6){
        transition-delay: 6000ms;
      }

      #preloader-text::after {
        content: "";
        position: absolute;
        left: 50%;
        bottom: 10px;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, rgba(200, 200, 200, 0.6) 10%, rgba(200, 200, 200, 0.2) 50%, transparent);
        filter: blur(16px);
        opacity: 0.9;
        transform: translateX(-50%) scale(1);
        animation: smoke-rise 5s ease-in-out forwards;
        pointer-events: none;
        transition: all 1s ease-in-out;
      }

      .pre-load-fade-out {
        opacity: 0;
        transition: opacity 7s ease-out;
        pointer-events: none;
      }

/*       @keyframes reveal {
            0% {
                opacity: 0; 
                letter-spacing: 0px;
              -webkit-text-stroke: 0px transparent;
              }
              60% {
                opacity: 0.6;
                letter-spacing: 10px;
                -webkit-text-stroke: 5px rgba(71, 143, 223, 0.5);
              }
              80% {
                opacity: 0.8;
                letter-spacing: 5px;
                -webkit-text-stroke: 6px rgba(71, 143, 223, 0.6);
              }
              90% {
                opacity: 0.8;
                letter-spacing: 2px;
                -webkit-text-stroke: 6px rgba(71, 143, 223, 0.8);
              }
              100% {
                opacity: 1; 
                background-size: 300% 300%;
                -webkit-text-stroke: 7px rgba(71, 143, 223, 1);
              }
            }

      @keyframes glow {
          0% {
              text-shadow: none;
              opacity: 0;
            }
            20% {
              text-shadow: 0 0 8px rgba(71, 143, 223, 0.4);
              opacity: 0.2;
            }
            40% {
              text-shadow: 0 0 8px rgba(71, 143, 223, 0.3);
              opacity: 0.4;
            }
            60% {
              text-shadow: 0 0 8px rgba(71, 143, 223, 0.2);
              opacity: 0.6;
            }
            80% {
              text-shadow: 0 0 8px rgba(71, 143, 223, 0.1);
              opacity: 0.8;
            }
            100% {
              text-shadow: none;
              opacity: 1;
            }
          } */

      @keyframes smoke-rise {
        0% {
            transform: translateX(-50%) translateY(0) scale(1);
            opacity: 1;
          }
          25% {
            opacity: 0.8;
          }
          50% {
            transform: translateX(-50%) translateY(-80px) scale(1.2);
            opacity: 0.65;
          }
          75% {
            opacity: 0.4;
          }
          100% {
            transform: translateX(-50%) translateY(-80px) scale(1.2);
            opacity: 0; /* Fade out the smoke effect */
          }
      }
    }
  </style>
</head>

<body>
  <div id="preloader">
    <div id="preloader-text">
      <span>P</span>
      <span>I</span>
      <span>C</span>
      <span>K</span>
      <span><br></span>
      <span>6</span>
      <!--       <img loading="lazy" id="football" src="https://raw.githubusercontent.com/joespick6/joespick6.github.io/refs/heads/main/FootballNew.gif" alt="Football" /> -->
    </div>
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="100" height="100">
      <defs>
        <clipPath id="fillClip">
          <rect id="fillRect" x="0" y="24" width="24" height="24" />
        </clipPath>
      </defs>
      <g clip-path="url(#fillClip)">
        <path
          d="M21.9127 5.93144c-0.159 -2.07975 -1.7644 -3.68517 -3.8441 -3.84419 -1.067 -0.08157 -2.312 -0.12112 -3.6237 -0.05102l7.5189 7.51892c0.0701 -1.3117 0.0305 -2.55678 -0.0511 -3.62371Z"
          fill="#4181c9" stroke-width="1"></path>
        <path
          d="M2.08725 18.0686c0.15902 2.0797 1.76444 3.6851 3.84419 3.8441 1.06718 0.0816 2.31259 0.1212 3.62463 0.051l-7.51979 -7.5198c-0.07017 1.3121 -0.03062 2.5575 0.05097 3.6247Z"
          fill="#4181c9" stroke-width="1"></path>
        <path fill-rule="evenodd" clip-rule="evenodd"
          d="M2.22237 12.5087c0.36847 -2.59228 1.26167 -5.23146 3.15827 -7.12806 1.89681 -1.89681 4.53636 -2.79 7.12886 -3.15839l9.2682 9.26825c-0.3683 2.5925 -1.2615 5.232 -3.1583 7.1289 -1.8966 1.8966 -4.5358 2.7898 -7.1281 3.1582l-9.26893 -9.2689Zm9.72023 -4.3486c0.2929 -0.29289 0.7678 -0.29289 1.0606 0l0.8882 0.8881 0.8881 -0.8881c0.2928 -0.29289 0.7677 -0.29289 1.0606 0 0.2929 0.29289 0.2929 0.76777 0 1.06066l-0.8881 0.88814 0.8881 0.8881c0.2929 0.2929 0.2929 0.7677 0 1.0606 -0.2929 0.2929 -0.7678 0.2929 -1.0606 0l-0.8881 -0.8881 -0.8306 0.8306 0.8881 0.8881c0.2929 0.2929 0.2929 0.7678 0 1.0607 -0.2929 0.2929 -0.7678 0.2929 -1.0607 0l-0.8881 -0.8881 -0.8306 0.8306 0.8881 0.8881c0.2929 0.2928 0.2929 0.7677 0 1.0606 -0.2929 0.2929 -0.7677 0.2929 -1.0606 0l-0.8881 -0.8881 -0.88814 0.8881c-0.29289 0.2929 -0.76777 0.2929 -1.06066 0s-0.29289 -0.7678 0 -1.0606l0.8881 -0.8881 -0.8881 -0.8882c-0.29289 -0.2928 -0.29289 -0.7677 0 -1.0606 0.29289 -0.2929 0.76777 -0.2929 1.06066 0l0.88814 0.8881 0.8305 -0.8306 -0.8881 -0.8881c-0.29285 -0.2929 -0.29285 -0.7678 0 -1.0607 0.2929 -0.29285 0.7678 -0.29285 1.0607 0l0.8881 0.8881 0.8306 -0.8305 -0.8881 -0.88814c-0.2929 -0.29289 -0.2929 -0.76777 0 -1.06066Z"
          fill="#4181c9" stroke-width="1"></path>
      </g>
    </svg>

    <button id="resetBtn" onclick="resetNotifications()" style="
                    display: none;
                    position: fixed;
                    bottom: 20px;
                    right: 12px;
                    background-color: transparent;
                    color: #478fdf;
                    border: 1px solid #478fdf;
                    padding: 7px 7px;
                    border-radius: 4px;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                    z-index: 1001;
                    transition: all 0.3s ease;">Reset Notifications</button>
  </div>

  <div id="install-banner">
    <p style="margin: 5px;">Add to Home Screen for the best experience</p>
    <button id="install-button">Add</button>
    <button id="dismiss-button">Dismiss</button>
  </div>

  <div id="ios-install-banner">
    <button id="ios-install-close">✕</button>
    <h3><img src="Pick6Logo.png" class="install-icon-header">Install 'Pick 6' on Your Device</h3>
    <p class="install-details">1. Tap the <strong>Share</strong> icon.<img src="https://raw.githubusercontent.com/BobcatPGAMajors/BobcatPGAMajors.github.io/refs/heads/main/shareIcon.png" alt="Share icon" class="install-icon">
    </p>
    <p class="install-details">2. Select <strong>Add to Home Screen</strong>.<img src="https://raw.githubusercontent.com/joespick6/joespick6.github.io/refs/heads/main/HomeScreenIcon.png" alt="Home Screen icon" class="install-icon">
    </p>
    <p class="install-details" style="margin-bottom: 8px;">3. Tap <strong>Add</strong>.</p>
  </div>

  <iframe
    src="https://script.google.com/macros/s/AKfycbwuZM7KGKnS7jnpM2YN9W_AgTMqA0qJGw99K3MIUNxzI1tnh3YK76AhgeCfh2Wc7pTd/exec"
    frameborder="0" scrolling="yes" loading="lazy"
    allow="fullscreen; clipboard-write; autoplay; camera; encrypted-media; geolocation; microphone; midi; payment; usb; accelerometer; gyroscope; magnetometer; screen-wake-lock; clipboard-read; web-share; autoplay; camera; encrypted-media; geolocation; microphone; midi; payment; usb; accelerometer; gyroscope; magnetometer; screen-wake-lock; clipboard-read; web-share"
    sandbox="allow-scripts allow-same-origin allow-forms">
  </iframe>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-J8ZSHET5RJ"></script>

  <script>
    let messaging;
    let db;

async function resetNotifications() {
    const button = document.getElementById('resetBtn');

    button.style.backgroundColor = '#478fdf';
    button.style.color = 'white';
    button.textContent = 'Resetting...';

    if (!checkStorageAvailability()) {
        showSuccessMessage('Storage unavailable. Please check browser settings.');

        button.style.backgroundColor = '#ff4d4d';
        button.textContent = 'Reset Failed';
        return;
    }

    console.log('Resetting notifications...');
    try {
        const registrations = await navigator.serviceWorker.getRegistrations();
        for (let registration of registrations) {
            await registration.unregister();
            console.log('Service worker unregistered');
        }
        await new Promise(resolve => setTimeout(resolve, 1000));
        if (messaging) {
            try {
                const token = await messaging.getToken().catch(err => {
                    console.log('No current token found:', err);
                    return null;
                });
                if (token) {
                    await messaging.deleteToken().catch(err => {
                        console.warn('Token deletion failed:', err);
                    });
                    console.log('Token deleted from FCM');
                } else {
                    console.log('No token to delete');
                }
                const deviceId = localStorage.getItem('deviceId');
                if (deviceId) {
                    const snapshot = await db.collection('devices')
                        .where('deviceId', '==', deviceId)
                        .get();
                    if (!snapshot.empty) {
                        const batch = db.batch();
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const updates = {};
                            if (data.activeTokens) {
                                Object.keys(data.activeTokens).forEach(t => {
                                    updates[`activeTokens.${t}`] = false;
                                });
                                batch.update(doc.ref, updates);
                            }
                        });
                        await batch.commit();
                        console.log('All tokens marked inactive in Firestore');
                    }
                }
            } catch (err) {
                console.error('Error processing token:', err);
            }
        }
        localStorage.removeItem('fcmToken');
        localStorage.removeItem('notificationPromptDismissed');
        localStorage.removeItem('notificationPermissionDenied');

        button.style.backgroundColor = '#478fdf';
        button.textContent = 'Reset Complete';

        if (Notification.permission === 'denied') {
            showSuccessMessage('Notifications blocked. Enable in browser settings.');
        } else if (Notification.permission === 'granted') {
            showSuccessMessage('Notifications reset. Please reauthorize.');
            setTimeout(() => {
                console.log('Forcing reauthorization...');
                forceNotificationRePrompt();
            }, 1500);
        } else {
            showSuccessMessage('Notifications reset. You will be prompted again.');
            setTimeout(() => {
                console.log('Reinitializing Firebase...');
                setupFirebaseAndNotifications();
            }, 1500);
        }

        setTimeout(function() {
            button.style.opacity = '0';
            setTimeout(function() {
                button.style.display = 'none';
            }, 300);
        }, 2500);

    } catch (err) {
        console.error('Reset failed:', err);
        showSuccessMessage('Failed to reset notifications. Try again.');

        button.style.backgroundColor = '#ff4d4d';
        button.textContent = 'Reset Failed';
    }
}

function forceNotificationRePrompt() {
    setupFirebaseAndNotifications();
}

function checkStorageAvailability() {
    return !!(navigator.storage && window.indexedDB);
}

function setupFirebaseAndNotifications() {
    const firebaseConfig = {
        apiKey: "AIzaSyB5r_KL2eKVFd66VQU_5pznKrVHa9xzCfc",
        authDomain: "joespick5push.firebaseapp.com",
        projectId: "joespick5push",
        storageBucket: "joespick5push.firebasestorage.app",
        messagingSenderId: "783669343677",
        appId: "1:783669343677:web:d3a43a1a58b920ba9a4ed4",
        measurementId: "G-HNPLN4XZ44"
    };

    if (!firebase.apps || !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }

    messaging = firebase.messaging();
    db = firebase.firestore();

if ('serviceWorker' in navigator) {
    const swPath = '/firebase-messaging-sw.js';
    console.log('Service worker path:', swPath);

    console.log('Attempting to register service worker at:', swPath);

    navigator.serviceWorker.register(swPath)
        .then(registration => {
            console.log('Service Worker registered with scope:', registration.scope);
            initializeNotifications(registration);
        })
        .catch(error => {
            console.error('Service Worker registration failed:', error.message);
        });
} else {
    console.log('Service workers not supported');
}

    function initializeNotifications(registration) {
        navigator.serviceWorker.addEventListener('message', event => {
            if (event.data && event.data.type === 'tokenRefresh') {
                console.log('Token refresh detected');
                refreshToken();
            }
        });

        function requestPermission() {
            return new Promise((resolve, reject) => {
                Notification.requestPermission()
                    .then(permission => {
                        if (permission === 'granted') {
                            console.log('Notification permission granted.');
                            messaging.getToken({
                                vapidKey: 'BOM3KFfemC5lGnsF28N-_UGA7H9esoOm5gp0_Eg45HMqaMqviLx_bcAonVaZe-c0GwSFwfwe7-fJVP1n8h1iAAU',
                                serviceWorkerRegistration: registration
                            })
                            .then(token => {
                                console.log('Device token:', token);
                                saveTokenToFirestore(token);
                                resolve(token);
                            })
                            .catch(error => {
                                console.error('Error getting token:', error);
                                reject(error);
                            });
                        } else {
                            console.log('Notification permission denied.');
                            localStorage.setItem('notificationPermissionDenied', 'true');
                            reject(new Error('Permission denied'));
                        }
                    })
                    .catch(error => {
                        console.error('Error requesting permission:', error);
                        reject(error);
                    });
            });
        }

        function refreshToken() {
            messaging.getToken({
                vapidKey: 'BOM3KFfemC5lGnsF28N-_UGA7H9esoOm5gp0_Eg45HMqaMqviLx_bcAonVaZe-c0GwSFwfwe7-fJVP1n8h1iAAU',
                serviceWorkerRegistration: registration
            }).then(refreshedToken => {
                console.log('Token refreshed:', refreshedToken);
                saveTokenToFirestore(refreshedToken);
            }).catch(err => {
                console.error('Unable to refresh token:', err);
            });
        }

        function createNotificationPrompt() {
            if (document.getElementById('notification-prompt')) {
                return;
            }

            const promptDiv = document.createElement('div');
            promptDiv.id = 'notification-prompt';
            promptDiv.style.cssText = `
                position: fixed;
                bottom: 50%;
                left: 50%;
                transform: translate(-50%, 50%);
                background: rgba(0, 0, 0, 0.85);
                color: white;
                padding: 8px 1px;
                border-radius: 10px;
                box-shadow: inset -3px -3px 4px 1px rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.9) 0px 10px 13px;
                text-align: center;
                z-index: 1001;
                font-family: Arial, sans-serif;
                max-width: 95%;
                width: max-content;
                border: 4px solid #478fdf;
                animation: fade-in 0.3s ease-in-out;
            `;

            promptDiv.innerHTML = `
                <p class="notification">You’ll get weekly push alerts when picks and entry forms are available.</p>
                <div style="display: flex; justify-content: space-between; gap: 10px;width: 104px;margin: 0 auto;">
                    <button id="enable-notifications" class="notification-button">OKAY</button>
                    <button id="decline-notifications" style="display: none;">Not Now</button>
                </div>
            `;

            document.body.appendChild(promptDiv);

document.getElementById('enable-notifications').addEventListener('click', () => {
    promptDiv.remove();
    requestPermission()
        .then(() => {
            showSuccessMessage('Notifications enabled successfully!');
        })
        .catch(error => {
            console.error('Error enabling notifications:', error);
        });
});

            document.getElementById('decline-notifications').addEventListener('click', () => {
                promptDiv.remove();
                localStorage.setItem('notificationPromptDismissed', Date.now());
            });
        }

async function saveTokenToFirestore(token, retries = 3) {
    if (!token) {
        console.error('No token provided to saveTokenToFirestore');
        return;
    }

    const deviceId = localStorage.getItem('deviceId') || generateDeviceId();
    localStorage.setItem('deviceId', deviceId);

    const browserInfo = {
        name: /Chrome/i.test(navigator.userAgent) ? 'Chrome' : 
            /Safari/i.test(navigator.userAgent) ? 'Safari' : 
            /Firefox/i.test(navigator.userAgent) ? 'Firefox' : 
            /Edge/i.test(navigator.userAgent) ? 'Edge' : 'Other',
        userAgent: navigator.userAgent,
    };

const attemptSave = async (attempt) => {
    try {
        const deviceQuery = await db.collection('devices')
            .where('deviceId', '==', deviceId)
            .get();

        if (!deviceQuery.empty) {
            const deviceDoc = deviceQuery.docs[0];
            const oldData = deviceDoc.data();

            let updateData = {
                lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                userAgent: browserInfo.userAgent,
                forceUpdate: Date.now()
            };

            if (oldData.tokens) {
                Object.keys(oldData.tokens).forEach(oldTokenKey => {
                    updateData[`tokens.${oldTokenKey}`] = firebase.firestore.FieldValue.delete();
                });
            }
            if (oldData.activeTokens) {
                Object.keys(oldData.activeTokens).forEach(oldToken => {
                    updateData[`activeTokens.${oldToken}`] = firebase.firestore.FieldValue.delete();
                });
            }

            updateData[`tokens.${browserInfo.name}`] = token;
            updateData[`activeTokens.${token}`] = true;

            console.log('Updating document:', deviceDoc.id);
            console.log('Update data:', updateData);

            await db.collection('devices').doc(deviceDoc.id).update(updateData);
            console.log('Device token updated successfully, old tokens deleted');

            const updatedDoc = await db.collection('devices').doc(deviceDoc.id).get({ source: 'server' });
            console.log('Updated lastActive:', updatedDoc.data().lastActive);

        } else {
            await db.collection('devices').add({
                deviceId: deviceId,
                platform: navigator.platform,
                tokens: { [browserInfo.name]: token },
                activeTokens: { [token]: true },
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                userAgent: browserInfo.userAgent
            });
            console.log('New device record created successfully');
        }

        localStorage.setItem('fcmToken', token);
        await cleanupDuplicateTokens(token, deviceId);

    } catch (error) {
        console.error(`Attempt ${attempt} failed:`, error.message);
        if (attempt < retries) {
            console.log(`Retrying... (${attempt + 1}/${retries})`);
            await new Promise(resolve => setTimeout(resolve, 1000));
            await attemptSave(attempt + 1);
        } else {
            console.error('Max retries reached. Device save failed.');
        }
    }
};
    await attemptSave(1);
}

async function cleanupDuplicateTokens(currentToken, deviceId) {
    try {
        const deviceQuery = await db.collection('devices')
            .where('deviceId', '==', deviceId)
            .get();

        if (deviceQuery.size > 1) {
            const sortedDocs = deviceQuery.docs.sort((a, b) => {
                const timeA = a.data().lastActive ? a.data().lastActive.toMillis() : 0;
                const timeB = b.data().lastActive ? b.data().lastActive.toMillis() : 0;
                return timeB - timeA;
            });

            const batch = db.batch();
            for (let i = 1; i < sortedDocs.length; i++) {
                batch.delete(sortedDocs[i].ref);
            }
            await batch.commit();
            console.log(`Cleaned up ${sortedDocs.length - 1} duplicate device records`);
        }

        const allDevicesWithToken = await db.collection('devices')
            .where(`activeTokens.${currentToken}`, '==', true)
            .get();

        if (!allDevicesWithToken.empty) {
            const batch = db.batch();
            let updateCount = 0;

            allDevicesWithToken.forEach(doc => {
                const data = doc.data();
                if (data.deviceId !== deviceId) {
                    batch.update(doc.ref, {
                        [`activeTokens.${currentToken}`]: firebase.firestore.FieldValue.delete(),
                        [`tokens.${Object.keys(data.tokens).find(key => data.tokens[key] === currentToken)}`]: firebase.firestore.FieldValue.delete()
                    });
                    updateCount++;
                }
            });

            if (updateCount > 0) {
                await batch.commit();
                console.log(`Deleted current token from ${updateCount} other devices`);
            }
        }
    } catch (error) {
        console.error('Error cleaning up tokens:', error);
    }
}

        function generateDeviceId() {
            const deviceData = [
                navigator.userAgent,
                navigator.language,
                screen.width,
                screen.height,
                new Date().getTimezoneOffset()
            ].join('|');

            let hash = 0;
            for (let i = 0; i < deviceData.length; i++) {
                const char = deviceData.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'device_' + Math.abs(hash);
        }

        function checkAndShowNotifications() {
    console.log('Checking notification state...');
    console.log('Current permission:', Notification.permission);
if (isDesktop()) {
        console.log('Desktop detected, skipping notification setup.');
        return;
    }
                  
    const wasReset = !localStorage.getItem('fcmToken') && !localStorage.getItem('notificationPromptDismissed');

    if (Notification.permission === 'granted' && !wasReset) {
        const storedToken = localStorage.getItem('fcmToken');
        const storedDeviceId = localStorage.getItem('deviceId');

        if (storedToken) {
            messaging.getToken().then(currentToken => {
                if (currentToken !== storedToken) {
                    console.log('Token has changed, updating...');
                    saveTokenToFirestore(currentToken);
                } else {
                    console.log('Token still valid');
                    if (storedDeviceId) {
                        db.collection('devices')
                            .where('deviceId', '==', storedDeviceId)
                            .get()
                            .then(snapshot => {
                                if (!snapshot.empty) {
                                    const doc = snapshot.docs[0];
                                    const data = doc.data();
                                    if (!data.activeTokens || !data.activeTokens[currentToken]) {
                                        console.log('Token exists but not active, reactivating...');
                                        saveTokenToFirestore(currentToken);
                                    }
                                }
                            })
                            .catch(err => console.error('Error checking token status:', err));
                    }
                }
            }).catch(error => {
                requestPermission();
            });
        } else {
            requestPermission();
        }
    } else {
        promptForPermission();
    }
}

function promptForPermission() {
    console.log('Prompting for permission...');
  if (isDesktop()) {
        console.log('Desktop detected, skipping notification prompt.');
        return;
    }
  
    if (Notification.permission === 'denied') {
        console.log('Notifications already denied');
    } else {
        const lastDismissed = localStorage.getItem('notificationPromptDismissed');
        const ONE_WEEK = 7 * 24 * 60 * 60 * 1000;

        if (!lastDismissed || (Date.now() - parseInt(lastDismissed)) > ONE_WEEK || !localStorage.getItem('fcmToken')) {
            const triggerPrompt = () => {
                clearTimeout(promptTimeout);
                document.removeEventListener('click', userInteracted);
                setTimeout(createNotificationPrompt, 1000);
            };

            const userInteracted = () => {
                console.log('User clicked, triggering prompt early');
                triggerPrompt();
            };

            document.addEventListener('click', userInteracted, { once: true });
            const promptTimeout = setTimeout(() => {
                console.log('10 seconds elapsed, triggering prompt');
                document.removeEventListener('click', userInteracted);
                triggerPrompt();
            }, 6000);

            setTimeout(() => {
                console.log('Starting prompt wait period (click or 10 seconds)');
            }, 2000);
        }
    }
}

        const styleSheet = document.createElement("style");
        styleSheet.textContent = `
            @keyframes fade-in {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes fade-out {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            @keyframes slide-in {
                from { transform: translateX(100%); }
                to { transform: translateX(0); }
            }
            @keyframes slide-out {
                from { transform: translateX(0); }
                to { transform: translateX(100%); }
            }
        `;
        document.head.appendChild(styleSheet);

        checkAndShowNotifications();
    }
}

function showSuccessMessage(message) {
    const successDiv = document.createElement('div');
    successDiv.style.cssText = `
        position: fixed;
        bottom: 50%;
        left: 50%;
        transform: translate(-50%, 50%);
        width: fit-content;
        min-width: 200px;
        white-space: nowrap;
        z-index: 1010;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 8px 8px;
        border-radius: 10px;
        box-shadow: rgba(0, 0, 0, 0.9) 0px 10px 13px;
        text-align: center;
        font-family: Arial, sans-serif;
        max-width: 90%;
        width: max-content;
        border: 2px solid rgb(71, 143, 223);
        animation: fade-in 0.5s ease-in-out;
    `;
    successDiv.textContent = message;
    document.body.appendChild(successDiv);
    setTimeout(() => {
        successDiv.style.animation = 'fade-out 0.3s ease-in-out';
        setTimeout(() => successDiv.remove(), 500);
    }, 5000);
}

document.addEventListener('DOMContentLoaded', function() {
    const preloader = document.getElementById('preloader');
    const resetButton = document.getElementById('resetBtn');
    // Show reset button only in standalone mode
    if (!isStandalone()) {
        resetButton.style.display = 'none';
    }
    setTimeout(() => {
        preloader.style.display = 'none';
      // preloader.style.transition = '2s ease-in-out';
        setupFirebaseAndNotifications();
    }, 7000);
});

let deferredPrompt;

function isDesktop() {
    const userAgent = navigator.userAgent.toLowerCase();
    const isDesktopUA = /windows nt|macintosh|linux/i.test(userAgent) && !/mobile|android|iphone|ipad|ipod/i.test(userAgent);
    const isLargeScreen = window.innerWidth > 1024;
    return isDesktopUA && isLargeScreen;
}

function isAndroid() {
    return /Android/i.test(navigator.userAgent);
}

function setupInstallPrompt() {
    const installBanner = document.getElementById('install-banner');
    const iosInstallBanner = document.getElementById('ios-install-banner');
    const installButton = document.getElementById('install-button');
    const dismissButton = document.getElementById('dismiss-button');
    const iosCloseButton = document.getElementById('ios-install-close');

    if (isDesktop()) {
        installBanner.style.display = 'none';
        iosInstallBanner.style.display = 'none';
        return;
    }

    if (isStandalone()) {
        installBanner.style.display = 'none';
        iosInstallBanner.style.display = 'none';
        return;
    }

    if (isIOS()) {
        iosInstallBanner.style.display = 'block';
        iosCloseButton.addEventListener('click', () => {
            iosInstallBanner.style.display = 'none';
        });
    } else {
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBanner.style.display = 'block';
        });
    }

    installButton.addEventListener('click', () => {
        if (deferredPrompt) {
            installBanner.style.display = 'none';
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                } else {
                    console.log('User dismissed the install prompt');
                }
                deferredPrompt = null;
            });
        }
    });

    dismissButton.addEventListener('click', () => {
        installBanner.style.display = 'none';
    });
}

const fillRect = document.getElementById('fillRect');
let progress = 0;
const duration = 6000; // 6 seconds
const startTime = performance.now();

function animate(time) {
  const elapsed = time - startTime;
  progress = Math.min(elapsed / duration, 1) * 24;
  fillRect.setAttribute('y', 24 - progress);
  fillRect.setAttribute('height', progress);
  if (elapsed < duration) requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

document.addEventListener('DOMContentLoaded', () => {
    setupInstallPrompt();
  gtag('event', 'app_mode', {
        'event_category': 'User Engagement',
        'event_label': isStandalone() ? 'Standalone App' : 'Browser',
        'value': isStandalone() ? 1 : 0
    });
});

function isIOS() {
    return /iPhone|iPad|iPod/i.test(navigator.userAgent);
}

function isStandalone() {
    return window.matchMedia('(display-mode: standalone)').matches;
}

  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-J8ZSHET5RJ');
   
  </script>
</body>

</html>
